---
import { SITE, NAV_ITEMS, SOCIAL_LINKS } from "@/config";
import ThemeToggle from "@/components/theme/ThemeToggle.astro";
import Button from "@/components/ui/Button.astro";
import CommandPalette from "@/components/search/CommandPalette";
import NavDropdown from "@/components/layout/NavDropdown.astro";

const home = SITE.homeUrl || "/";
---

<header id="main-header" class="fixed top-0 left-0 right-0 z-50 bg-[var(--color-background)]/80 backdrop-blur-md border-b border-[var(--color-base-300)]/50">
  <div class="layout-container h-16 flex items-center justify-between relative">

    {/* Mobile: Logo (Left) */}
    <a href={home} class="lg:hidden flex-1 flex justify-start items-center shrink-0 text-left p-1 -ml-1 z-20">
      {SITE.logo && <img src={SITE.logo} alt={SITE.title} class="h-8 w-8" />}
      <span class="ml-2 font-serif text-lg text-[var(--color-base-content)]">1ar.io</span>
    </a>

    {/* Mobile: Centered Chevron Toggle */}
    <div class="lg:hidden absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-30">
      <button
        id="mobile-menu-toggle-chevron"
        class="p-2 rounded-full text-base-content hover:bg-base-200/70 focus:outline-none transition-colors duration-150"
        aria-label="Toggle menu"
        aria-expanded="false"
        aria-controls="mobile-inline-menu"
      >
        <i id="icon-chevron" class="ri-arrow-down-s-line text-2xl block"></i>
      </button>
    </div>

    {/* Mobile: CTA (Right) */}
    <div class="lg:hidden flex-1 flex justify-end items-center z-20">
      <Button href={`${SITE.homeUrl}/contact`} variant="light" size="sm">Contact</Button>
    </div>

    {/* Desktop: Logo + Search */}
    <div class="hidden lg:flex items-center gap-3 shrink-0 z-10">
      <a href={home} class="logo-link flex items-center">
        {SITE.logo && <img src={SITE.logo} alt={SITE.title} class="h-8 w-8" />}
        <span class="ml-2 font-serif text-xl text-[var(--color-base-content)]">1ar.io</span>
        <span class="logo-tooltip">Pavel Larionov aka pa1ar</span>
      </a>
      <CommandPalette baseUrl={SITE.homeUrl} client:load />
    </div>

    {/* Desktop: Centered Navigation */}
    <nav class="hidden lg:flex absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-[calc(50%-2px)] items-center gap-6 font-mono z-0">
      {NAV_ITEMS.map(link => (
        link.children ? (
          <NavDropdown item={link} />
        ) : (
          <a href={link.href} class="text-[var(--color-base-content)] hover:text-[var(--color-primary)] transition-colors text-sm">
            {link.label}
          </a>
        )
      ))}
    </nav>

    {/* Desktop: Right Actions */}
    <div class="hidden lg:flex items-center gap-4 z-10 translate-y-[2px]">
      <nav class="flex items-center gap-2">
        {SOCIAL_LINKS.map(social => (
          <a
            href={social.href}
            target="_blank"
            rel="noopener noreferrer"
            class="text-[var(--color-base-content)] hover:text-[var(--color-primary)] transition-colors"
            aria-label={social.name}
          >
            <i class={`${social.icon} text-base`}></i>
          </a>
        ))}
      </nav>
      <ThemeToggle />
      <Button href={`${SITE.homeUrl}/contact`} variant="light" size="sm" class="font-normal">Contact</Button>
    </div>
  </div>

  {/* Mobile Inline Menu */}
  <div
    id="mobile-inline-menu"
    class="lg:hidden px-4 overflow-y-auto overflow-x-hidden max-h-0 opacity-0 transition-all duration-300 ease-in-out flex flex-col items-center bg-[var(--color-background)]/90 backdrop-blur-md"
    style="scrollbar-gutter: stable both-edges;"
  >
    <nav class="flex flex-col w-full items-center pt-4 pb-2 space-y-1">
      {NAV_ITEMS.map((link) => (
        link.children ? (
          <div class="mobile-accordion w-full max-w-xs">
            <button
              class="mobile-accordion-trigger flex items-center justify-center gap-1 w-full px-3 py-2 rounded-md text-base font-medium text-[var(--color-base-content)] hover:bg-[var(--color-base-200)] hover:text-[var(--color-primary)] transition-colors font-mono"
              aria-expanded="false"
            >
              {link.label}
              <i class="ri-arrow-down-s-line text-sm transition-transform duration-200"></i>
            </button>
            <div class="mobile-accordion-content overflow-hidden max-h-0 transition-all duration-200 ease-in-out">
              <div class="flex flex-col items-center py-1 space-y-1">
                {link.children.map((child) => (
                  <a
                    href={child.href}
                    class="flex items-center gap-2 px-4 py-1.5 rounded-md text-sm text-[var(--color-base-content)] hover:bg-[var(--color-base-200)] hover:text-[var(--color-primary)] transition-colors font-mono"
                    {...(child.external ? { target: "_blank", rel: "noopener noreferrer" } : {})}
                  >
                    {child.favicon && (
                      <img src={child.favicon} alt="" width="14" height="14" class="rounded-sm" />
                    )}
                    <span>{child.label}</span>
                    {child.external && (
                      <i class="ri-external-link-line text-[10px] opacity-40"></i>
                    )}
                  </a>
                ))}
              </div>
            </div>
          </div>
        ) : (
          <a
            href={link.href}
            class="block px-3 py-2 rounded-md text-base font-medium text-[var(--color-base-content)] hover:bg-[var(--color-base-200)] hover:text-[var(--color-primary)] transition-colors font-mono text-center"
          >
            {link.label}
          </a>
        )
      ))}
    </nav>
    <hr class="border-gray-300 dark:border-gray-600 my-3 w-full max-w-xs" />
    <div class="py-2 flex justify-center">
      <ThemeToggle />
    </div>
    <div class="pt-2 pb-4">
      <div class="flex items-center justify-center gap-4">
        {SOCIAL_LINKS.map((social) => (
          <a
            href={social.href}
            target="_blank"
            rel="noopener noreferrer"
            class="text-[var(--color-base-content)] hover:text-[var(--color-primary)] transition-colors text-xl"
            aria-label={social.name}
          >
            <i class={social.icon}></i>
          </a>
        ))}
      </div>
    </div>
  </div>
</header>

<script>
  const chevronMenuButton = document.getElementById('mobile-menu-toggle-chevron');
  const mobileMenu = document.getElementById('mobile-inline-menu');
  const iconChevron = document.getElementById('icon-chevron');

  let collapsedHeight = 0;

  function getAvailableHeight() {
    const header = mobileMenu?.closest('header');
    const headerBottom = header ? header.getBoundingClientRect().bottom : 0;
    return window.innerHeight - headerBottom;
  }

  function cappedHeight() {
    if (!mobileMenu) return '0px';
    const available = getAvailableHeight();
    const natural = Math.max(mobileMenu.scrollHeight, collapsedHeight);
    return `${Math.min(natural, available)}px`;
  }

  function openMobileMenu() {
    if (!mobileMenu) return;
    // capture baseline height on first open (all accordions collapsed)
    if (!collapsedHeight) {
      mobileMenu.style.maxHeight = 'none';
      collapsedHeight = mobileMenu.scrollHeight;
      mobileMenu.style.maxHeight = '0px';
    }
    mobileMenu.style.maxHeight = cappedHeight();
    mobileMenu.classList.remove('opacity-0');
    mobileMenu.classList.add('opacity-100');
    chevronMenuButton?.setAttribute('aria-expanded', 'true');
    iconChevron?.classList.add('is-open');
  }

  function closeMobileMenu() {
    if (!mobileMenu) return;
    mobileMenu.style.maxHeight = '0px';
    mobileMenu.classList.add('opacity-0');
    mobileMenu.classList.remove('opacity-100');
    chevronMenuButton?.setAttribute('aria-expanded', 'false');
    iconChevron?.classList.remove('is-open');
  }

  chevronMenuButton?.addEventListener('click', (event) => {
    event.stopPropagation();
    const isOpen = chevronMenuButton.getAttribute('aria-expanded') === 'true';
    if (isOpen) {
      closeMobileMenu();
    } else {
      openMobileMenu();
    }
  });

  mobileMenu?.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', closeMobileMenu);
  });

  // mobile accordion for nav items with children
  document.querySelectorAll('.mobile-accordion-trigger').forEach((trigger) => {
    trigger.addEventListener('click', () => {
      const accordion = trigger.closest('.mobile-accordion');
      const content = accordion?.querySelector('.mobile-accordion-content') as HTMLElement;
      const icon = trigger.querySelector('i');
      if (!content) return;

      const isOpen = trigger.getAttribute('aria-expanded') === 'true';
      if (isOpen) {
        content.style.maxHeight = '0px';
        trigger.setAttribute('aria-expanded', 'false');
        icon?.classList.remove('is-open');
      } else {
        content.style.maxHeight = `${content.scrollHeight}px`;
        trigger.setAttribute('aria-expanded', 'true');
        icon?.classList.add('is-open');
      }

      // update parent mobile menu max-height to accommodate expanded content
      if (mobileMenu) {
        requestAnimationFrame(() => {
          mobileMenu.style.maxHeight = cappedHeight();
        });
      }
    });
  });

  document.addEventListener('click', (event) => {
    const isOpen = chevronMenuButton?.getAttribute('aria-expanded') === 'true';
    if (isOpen && mobileMenu && chevronMenuButton) {
      const target = event.target as Node;
      if (!mobileMenu.contains(target) && !chevronMenuButton.contains(target)) {
        closeMobileMenu();
      }
    }
  });
</script>

<style>
  #icon-chevron {
    display: block;
    transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: center;
  }

  #icon-chevron.is-open {
    transform: rotate(180deg);
  }

  .mobile-accordion-trigger i.is-open {
    transform: rotate(180deg);
  }

  .logo-link {
    position: relative;
  }

  .logo-tooltip {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 8px;
    padding: 6px 12px;
    font-family: ui-monospace, monospace;
    font-size: 0.8rem;
    white-space: nowrap;
    color: var(--color-base-content);
    background: var(--color-base-200);
    border: 1px solid var(--color-base-300);
    border-radius: 6px;
    pointer-events: none;
    opacity: 0;
    transform: translateY(4px);
    transition: opacity 0.2s ease, transform 0.2s ease;
  }

  .logo-link:hover .logo-tooltip {
    opacity: 1;
    transform: translateY(0);
  }
</style>
